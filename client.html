<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Retro TV â€” Client</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;background:black;overflow:hidden;}
  video,img{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;background:black;}
  #log{position:absolute;left:8px;top:8px;color:#ccc;font-family:monospace;font-size:12px;white-space:pre-wrap;}
</style>
</head>
<body>

<video id="player" autoplay playsinline controls></video>
<img id="maintenance" src="maintenance.png" style="display:none">

<div id="log"></div>

<script>
(async function(){
  const player = document.getElementById('player');
  const maintenance = document.getElementById('maintenance');
  const logEl = document.getElementById('log');
  function log(...args){ logEl.textContent += args.join(' ') + '\n'; }

  const channel = new BroadcastChannel('retrotv-signal');
  const pc = new RTCPeerConnection({ bundlePolicy:'max-bundle' });
  let dc=null, incomingChunks=[], incomingMeta=null;

  pc.ondatachannel = e=>{
    dc = e.channel;
    dc.binaryType='arraybuffer';
    dc.onopen=()=>log('DataChannel open');
    dc.onclose=()=>log('DataChannel closed');
    dc.onmessage=ev=>{
      if(typeof ev.data==='string'){
        try{
          const obj = JSON.parse(ev.data);
          if(obj.end){
            const blob = new Blob(incomingChunks,{type:incomingMeta?.type||'video/mp4'});
            const url = URL.createObjectURL(blob);
            player.src = url;
            player.style.display='';
            maintenance.style.display='none';
            player.play().catch(()=>{});
            incomingChunks=[]; incomingMeta=null;
            player.onended=()=>{
              maintenance.style.display='';
              player.style.display='none';
              setTimeout(()=>{ URL.revokeObjectURL(url); player.src=''; },1000);
            };
          } else { incomingMeta=obj; incomingChunks=[]; }
        }catch(e){ log('JSON parse error:',e); }
      } else { incomingChunks.push(ev.data); }
    };
  };

  // Receive offer from host via BroadcastChannel
  channel.onmessage = async ev=>{
    const msg = ev.data;
    if(msg.type==='offer'){
      log('Offer received from host');
      await pc.setRemoteDescription({ type:'offer', sdp:msg.sdp });
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      channel.postMessage({ type:'answer', sdp:pc.localDescription.sdp });
      log('Answer sent back to host. Waiting for broadcast...');
    }
  };

})();
</script>
</body>
</html>