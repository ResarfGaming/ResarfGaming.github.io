<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Retro TV — Host</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { font-family: system-ui,sans-serif; padding:20px; max-width:900px; }
  h1 { margin-top:0; }
  input[type=file]{ width:100%; }
  button { padding:10px 14px; font-size:15px; margin-top:10px; }
  textarea { width:100%; height:200px; font-family:monospace; margin-top:8px; box-sizing:border-box; }
  #log { font-family:monospace; font-size:12px; color:#333; margin-top:8px; white-space:pre-wrap; }
</style>
</head>
<body>
<h1>Retro TV — Host</h1>

<label>Select a video file to broadcast (one file):</label>
<input id="fileInput" type="file" accept="video/*">

<div style="margin-top:12px;">
  <button id="createOffer">Create Offer</button>
  <button id="broadcast" disabled>Broadcast</button>
</div>

<div id="log"></div>

<script>
(async function(){
  const CHUNK = 64*1024; // 64KB
  const fileInput = document.getElementById('fileInput');
  const createBtn = document.getElementById('createOffer');
  const broadcastBtn = document.getElementById('broadcast');
  const logEl = document.getElementById('log');
  function log(...args){ logEl.textContent += args.join(' ') + '\n'; }

  // BroadcastChannel for signaling
  const channel = new BroadcastChannel('retrotv-signal');

  const pc = new RTCPeerConnection({ bundlePolicy:'max-bundle' });
  let dc = null;

  // Create offer and DataChannel
  createBtn.addEventListener('click', async ()=>{
    dc = pc.createDataChannel('tv');
    dc.binaryType = 'arraybuffer';
    dc.onopen = ()=> { log('DataChannel open'); broadcastBtn.disabled = false; };
    dc.onclose = ()=> { log('DataChannel closed'); broadcastBtn.disabled = true; };
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    log('Offer created. Sending to client via BroadcastChannel...');
    channel.postMessage({ type:'offer', sdp:pc.localDescription.sdp });
  });

  // Receive answer from client
  channel.onmessage = async (ev)=>{
    const msg = ev.data;
    if(msg.type==='answer'){
      await pc.setRemoteDescription({ type:'answer', sdp: msg.sdp });
      log('Remote description set. Ready to broadcast.');
    }
  };

  // Broadcast file in chunks
  broadcastBtn.addEventListener('click', async ()=>{
    if(!dc || dc.readyState!=='open') return alert('DataChannel not open.');
    const file = fileInput.files[0];
    if(!file) return alert('Select a video file first.');
    log('Broadcasting file:', file.name, file.size, 'bytes');
    dc.send(JSON.stringify({ name:file.name, size:file.size, type:file.type||'video/mp4' }));
    for(let offset=0; offset<file.size; offset+=CHUNK){
      const slice = file.slice(offset, Math.min(offset+CHUNK,file.size));
      dc.send(await slice.arrayBuffer());
      while(dc.bufferedAmount > CHUNK*6) await new Promise(r=>setTimeout(r,40));
    }
    dc.send(JSON.stringify({ end:true }));
    log('Broadcast complete.');
    alert('Broadcast complete.');
  });

})();
</script>
</body>
</html>